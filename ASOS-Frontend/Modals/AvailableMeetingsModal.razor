@using System.Globalization
@using System.Text.Json
@using System.Text
@using System.Net

@inject Radzen.DialogService DialogService
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar

<style>
	.rz-pager-summary {
		box-shadow: unset !important;
	}

	.rz-pager-element {
		box-shadow: unset !important;
	}

	#available-meeting-list .rz-card {
		min-height: unset !important;
	}
</style>

<RadzenStack Style="gap:10px; min-width:350px; max-width:450px; height:100%;">
	<RadzenRow Style="padding-left:8px">
		<RadzenDatePicker @bind-Value=@SelectDate Name="RadzenDatePickerBindValue" ShowCalendarWeek AllowClear Placeholder="Dátum" DateFormat="dd.MM.yyyy" Culture='new CultureInfo("sk-SK")' class="rz-shadow-5" />
	</RadzenRow>
	<RadzenDataList id="available-meeting-list" AllowVirtualization="false"
					WrapItems="true" AllowPaging="true" PagerAlwaysVisible="true" EmptyText="Zoznam je prázdny, skontrolujte zvolené filtre."
					Data="@filteredMeetingsList" TItem="MeetingDto" PageSize="5" PagerHorizontalAlign="HorizontalAlign.Left"
					ShowPagingSummary="true" PagingSummaryFormat="Strana {0} / {1}">
		<Template Context="meeting">
			<RadzenCard Variant="Radzen.Variant.Outlined" class="rz-p-2 rz-shadow-3 rz-border-radius-3" Style="width: 100%; overflow: hidden;">
				<RadzenRow JustifyContent="JustifyContent.SpaceEvenly" Gap="0.3rem">
					<RadzenStack Gap="0.2rem">
						<RadzenText TextStyle="TextStyle.H6" TagName="TagName.H5" class="rz-mb-0" Style="width:fit-content">Dátum a čas</RadzenText>
						<RadzenText TextStyle="TextStyle.Body2" Style="font-size:1.1rem; width:fit-content">@(meeting.Beginning)</RadzenText>
					</RadzenStack>
					<MudButton Variant="MudBlazor.Variant.Filled" StartIcon="@Icons.Material.Filled.HistoryEdu" Color="MudBlazor.Color.Info" Style="width: 175px; border-radius:25px;" @onclick="() => ReturnSelectedMeeting(meeting)">Zapísať termín</MudButton>
				</RadzenRow>
			</RadzenCard>
		</Template>
	</RadzenDataList>
</RadzenStack>

@code {
	[Parameter]
	public CourseDto Course { get; set; }

	List<MeetingDto> meetingsList;
	List<MeetingDto> filteredMeetingsList;

	DateTime? selectedDate;

	public DateTime? SelectDate
	{
		get
		{
			return selectedDate;
		}
		set
		{
			if (selectedDate == value)
			{
				return;
			}

			selectedDate = value;

			ApplyFilters();
		}
	}

	protected override async Task OnInitializedAsync()
	{
		var httpClient = HttpClientFactory.CreateClient("API");
		var meetingsResponse = await httpClient.GetAsync($"courseMeetings/{Course.Id}");
        var errorMessage = await meetingsResponse.Content.ReadAsStringAsync();
		if (meetingsResponse.IsSuccessStatusCode)
		{
			var meetingsJson = await meetingsResponse.Content.ReadAsStringAsync();
			meetingsList = JsonSerializer.Deserialize<List<MeetingDto>>(meetingsJson);
		}
        else if (errorMessage == "User does not exist.")
        {
            Snackbar.Add("Študent neexistuje.", Severity.Error);
        }
        else if (errorMessage == "Only student can use this endpoint: /courseMeetings/{courseId}.")
        {
            Snackbar.Add("Iba študent sa môže zapísať na termín.", Severity.Error);
        }
		filteredMeetingsList = meetingsList;
	}

	void ApplyFilters()
	{
		filteredMeetingsList = meetingsList.ToList();

		if (selectedDate != null)
		{
			filteredMeetingsList = filteredMeetingsList
				.Where(x => x.Beginning.Date == selectedDate.Value.Date)
				.ToList();
		}

		if (selectedDate == null)
		{
			filteredMeetingsList = meetingsList;
		}
	}


	void ReturnSelectedMeeting(MeetingDto meeting)
	{
		DialogService.Close(meeting);
	}
}
